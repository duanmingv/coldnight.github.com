<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>cold's world</title><link href="http://localhost:8000/" rel="alternate"></link><link href="http://www.linuxzen.com/feeds/mysql.atom.xml" rel="self"></link><id>http://localhost:8000/</id><updated>2012-02-12T17:01:00+08:00</updated><entry><title>heartbeat实现MySQL双机高可用</title><link href="http://localhost:8000/heartbeatshi-xian-mysqlshuang-ji-gao-ke-yong.html" rel="alternate"></link><updated>2012-02-12T17:01:00+08:00</updated><author><name>cold</name></author><id>tag:localhost:8000,2012-02-12:heartbeatshi-xian-mysqlshuang-ji-gao-ke-yong.html</id><summary type="html">&lt;p&gt;对于一个网站或一个企业最重要的无疑就是数据,那么数据库的数据安全无疑就更加重要,所以我们必须保证数据库的数据完整,这里就介绍使用heartbeat来实现MySQL双机高可用.&lt;/p&gt;
&lt;p&gt;当我们的MySQL数据库故障或MySQL数据库服务器出现故障的时候我们希望有一个备用能自动代替主MySQL数据来完成当前的任务,当主MySQL服务器恢复故障的时候备用的能切换到备用等待下一次故障出现.这里我们就结合故障检测HA来实现.&lt;/p&gt;
&lt;p&gt;HA会定时发送心跳包检测主备服务器的健康状态,当主服务器出现故障时会自动将vip切换到备用服务器,由备用服务器执行主服务器的任务,MySQL要实现这样的功能就必须保证主备服务器的数据一致.这就要用到MySQL主从双机.
&lt;!--more--&gt;
本文使用环境:
系统:CentOS 5.5 32位
主MySQL: ip 192.168.3.101/24 主机名:master.org
备用MySQL:192.168.3.102/24   主机名:slave.org
vip:192.168.3.103/24
MySQL:mysql-5.0.95.tar.gz
heartbeat:Heartbeat-3-0-7e3a82377fa8.tar.bz2&lt;/p&gt;
&lt;h3&gt;一、安装部署MySQL&lt;/h3&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;yum -y install ncurses-devel openssl-devel
wget http://dev.mysql.com/get/Downloads/MySQL-5.0/mysql-5.0.95.tar.gz/from/http://mysql.cdpa.nsysu.edu.tw/
useradd -M -s /sbin/nologin mysql
tar -zxvf mysql-5.0.95.tar.gz
&lt;span class="nb"&gt;cd &lt;/span&gt;mysql-5.0.95
./configure --prefix&lt;span class="o"&gt;=&lt;/span&gt;/usr/local/mysql &lt;span class="se"&gt;\&lt;/span&gt;
--without-debug &lt;span class="se"&gt;\&lt;/span&gt;
--with-extra-charsets&lt;span class="o"&gt;=&lt;/span&gt;utf8,gbk &lt;span class="se"&gt;\&lt;/span&gt;
--enable-assembler &lt;span class="se"&gt;\&lt;/span&gt;
--with-mysqld-ldflags&lt;span class="o"&gt;=&lt;/span&gt;-all-static &lt;span class="se"&gt;\&lt;/span&gt;
--with-client-ldflags&lt;span class="o"&gt;=&lt;/span&gt;-all-static &lt;span class="se"&gt;\&lt;/span&gt;
--with-unix-socket-path&lt;span class="o"&gt;=&lt;/span&gt;/tmp/mysql.sock &lt;span class="se"&gt;\&lt;/span&gt;
--with-ssl
make &amp;amp;amp;&amp;amp;amp; make install
cp support-files/my-medium.cnf /etc/my.cnf          &lt;span class="c"&gt;# 创建配置文件&lt;/span&gt;
cp support-files/mysql.server /etc/init.d/mysqld     &lt;span class="c"&gt;# 创建启动脚本&lt;/span&gt;
chmod +x /etc/init.d/mysqld
&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;/usr/local/mysql/lib/mysql/&amp;#39;&lt;/span&gt; &amp;amp;gt;&amp;amp;gt; /etc/ld.so.conf
ldconfig
/usr/local/mysql/bin/mysql_install_db --user&lt;span class="o"&gt;=&lt;/span&gt;mysql   &lt;span class="c"&gt;# 初始化数据库&lt;/span&gt;
chown -R root.mysql /usr/local/mysql/
chown -R mysql.mysql /usr/local/mysql/var/
ln -s /usr/local/mysql/bin/* /usr/local/bin/ &lt;span class="c"&gt;# 为二进制文件做一个软链接&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;配置MySQl主从实现数据同步,在主从服务器上修改my.cnf(这里是新安装的数据库,如果是仅仅加从库,需要把主库的数据备份导入到从库,这里不再讲述)&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;vi /etc/my.cnf
&lt;span class="c"&gt;# [mysqld]里修改:&lt;/span&gt;
&lt;span class="nv"&gt;log_bin&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; /var/log/mysql/mysql-bin.log      &lt;span class="c"&gt;# 启动二进制文件&lt;/span&gt;
server-id &lt;span class="o"&gt;=&lt;/span&gt; 1921683101                      &lt;span class="c"&gt;# 设置服务器id&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;启动主库:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;service mysqld start
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;在主库上创建一个用户授权给从库,用户为backup密码为backup:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;mysql&amp;amp;gt; grant replication slave on *.* to &lt;span class="s1"&gt;&amp;#39;backup&amp;#39;&lt;/span&gt;@&lt;span class="s1"&gt;&amp;#39;192.168.3.102&amp;#39;&lt;/span&gt; identified by &lt;span class="s1"&gt;&amp;#39;backup&amp;#39;&lt;/span&gt;;
Query OK, 0 rows affected &lt;span class="o"&gt;(&lt;/span&gt;0.16 sec&lt;span class="o"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;查看主库状态:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;mysql&amp;amp;gt; show master status;
+------------------+-----------+--------------+------------------+
¦ File             ¦ Position  ¦ Binlog_Do_DB ¦ Binlog_Ignore_DB ¦
+------------------+-----------+--------------+------------------+
¦ mysql-bin.000003 ¦       236 ¦              ¦                  ¦
+------------------+-----------+--------------+------------------+
1 row in &lt;span class="nb"&gt;set&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;0.00 sec&lt;span class="o"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;修改从库配置文件:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;server-id &lt;span class="o"&gt;=&lt;/span&gt; 1921683102                 &lt;span class="c"&gt;# server id必须保持唯一&lt;/span&gt;
&lt;span class="nv"&gt;log_bin&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; /var/log/mysql/mysql-bin.log &lt;span class="c"&gt;# 启用二进制日志&lt;/span&gt;
master-host &lt;span class="o"&gt;=&lt;/span&gt; 192.168.3.101       &lt;span class="c"&gt;# 主库ip&lt;/span&gt;
master-user &lt;span class="o"&gt;=&lt;/span&gt; backup                  &lt;span class="c"&gt;# 账号&lt;/span&gt;
master-pass &lt;span class="o"&gt;=&lt;/span&gt; backup                 &lt;span class="c"&gt;# 密码&lt;/span&gt;
master-port &lt;span class="o"&gt;=&lt;/span&gt; 3306                      &lt;span class="c"&gt;# 连接主库的端口&lt;/span&gt;
master-connect-retry&lt;span class="o"&gt;=&lt;/span&gt;60             &lt;span class="c"&gt;# 连接失败后进行重试等待的描述&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;启动从库,并查看状态:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;service mysqld start
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;在从库上执行下操作,指定主库的二进制文件名和偏移量(刚才在主库show master status;查看的参数):&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;mysql&amp;amp;gt; show slave status &lt;span class="se"&gt;\G&lt;/span&gt;;
*************************** 1. row ***************************
             Slave_IO_State: Waiting &lt;span class="k"&gt;for &lt;/span&gt;master to send event
                Master_Host: 192.168.3.101
                Master_User: backup
                Master_Port: 3306
              Connect_Retry: 60
            Master_Log_File: mysql-bin.000003
        Read_Master_Log_Pos: 236
             Relay_Log_File: cfhost-relay-bin.000002
              Relay_Log_Pos: 235
      Relay_Master_Log_File: mysql-bin.000003
           Slave_IO_Running: Yes
          Slave_SQL_Running: Yes
            Replicate_Do_DB:
        Replicate_Ignore_DB:
         Replicate_Do_Table:
     Replicate_Ignore_Table:
    Replicate_Wild_Do_Table:
Replicate_Wild_Ignore_Table:
                 Last_Errno: 0
                 Last_Error:
               Skip_Counter: 0
        Exec_Master_Log_Pos: 236
            Relay_Log_Space: 235
            Until_Condition: None
             Until_Log_File:
              Until_Log_Pos: 0
         Master_SSL_Allowed: No
         Master_SSL_CA_File:
         Master_SSL_CA_Path:
            Master_SSL_Cert:
          Master_SSL_Cipher:
             Master_SSL_Key:
      Seconds_Behind_Master: 0
1 row in &lt;span class="nb"&gt;set&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;0.00 sec&lt;span class="o"&gt;)&lt;/span&gt;

ERROR:
No query specified
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;如果show slave status \G;&lt;span style="color: #ff0000;"&gt;Slave_SQL_Running: No&lt;/span&gt;&lt;span style="color: #000000;"&gt;,则执在从库上执行下面命令(两个参数值通过在主库执行show master status; 命令查看获得):
&lt;/span&gt;&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;mysql&amp;amp;gt; stop slave;
Query OK, 0 rows affected &lt;span class="o"&gt;(&lt;/span&gt;0.00 sec&lt;span class="o"&gt;)&lt;/span&gt;

mysql&amp;amp;gt; change master to &lt;span class="nv"&gt;master_log_file&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;mysql-bin.000003&amp;#39;&lt;/span&gt;,master_log_pos&lt;span class="o"&gt;=&lt;/span&gt;236;
Query OK, 0 rows affected &lt;span class="o"&gt;(&lt;/span&gt;0.01 sec&lt;span class="o"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;&amp;nbsp;&lt;/p&gt;
&lt;p&gt;在主库上创建一个数据库看看是否同步.&lt;/p&gt;
&lt;h3&gt;二、安装部署heartbeat实现双机热备份&lt;/h3&gt;
&lt;h3&gt;安装依赖&lt;/h3&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;yum  -y install pkgconfig glib2-devel python-devel pam-devel gnutls-devel swig
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;安装libnet&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;wget http://download.fedora.redhat.com/pub/epel/5/i386/libnet-1.1.5-1.el5.i386.rpm
rpm -ivh libnet-1.1.5-1.el5.i386.rpm
wget http://download.fedora.redhat.com/pub/epel/5/i386/libnet-devel-1.1.5-1.el5.i386.rpm
rpm -ivh libnet-devel-1.1.5-1.el5.i386.rpm
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;安装:&lt;/h3&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;useradd -M -s /sbin/nologin hacluster
useradd -M -s /sbin/nologin haclient
wget http://www.ultramonkey.org/download/heartbeat/2.0.8/heartbeat-2.0.8.tar.gz
tar -zxvf heartbeat-2.0.8.tar.gz
&lt;span class="nb"&gt;cd &lt;/span&gt;heartbeat-2.0.8
./configure --sysconfdir&lt;span class="o"&gt;=&lt;/span&gt;/etc
make &amp;amp;amp;&amp;amp;amp; make install
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;创建配置文件:
安装后要配置三个文件（如没有可手动建立）：ha.cf、haresources、authkeys。这三个配置文件需要在/etc/ha.d目录下面，但是默认是没有这三个文件的，可以到官网上下这三个文件，也可以在源码包里找这三个文件，在源码目录下的DOC子目录里。&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;cat /usr/local/share/doc/heartbeat-2.0.8/ha.cf | egrep -v &lt;span class="s1"&gt;&amp;#39;^#\W&amp;#39;&lt;/span&gt; | grep -v &lt;span class="s1"&gt;&amp;#39;^#$&amp;#39;&lt;/span&gt; &amp;amp;gt;&amp;amp;gt; /etc/ha.d/ha.cf
cat /usr/local/share/doc/heartbeat-2.0.8/haresources  | egrep -v &lt;span class="s1"&gt;&amp;#39;^#\W&amp;#39;&lt;/span&gt; | grep -v &lt;span class="s1"&gt;&amp;#39;^#$&amp;#39;&lt;/span&gt; &amp;amp;gt;&amp;amp;gt; /etc/ha.d/haresources
cat /usr/local/share/doc/heartbeat-2.0.8/authkeys | egrep -v &lt;span class="s1"&gt;&amp;#39;^#\W&amp;#39;&lt;/span&gt; | grep &lt;span class="s1"&gt;&amp;#39;^#$&amp;#39;&lt;/span&gt; -v &amp;amp;gt; /etc/ha.d/authkeys
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;编辑配置文件:&lt;/p&gt;
&lt;p&gt;编辑ha.cf,该文件中包括为Heartbeat使用何种介质通路和如何配置他们的信息.&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt; vi /etc/ha.d/ha.cf 

debugfile /var/log/ha-debug   &lt;span class="c"&gt;# 用于记录heartbeat的调试信息&lt;/span&gt;
logfile /var/log/ha-log       &lt;span class="c"&gt;# 用于记录heartbeat的日志信息&lt;/span&gt;
logfacility     local0
keepalive 2         &lt;span class="c"&gt;# 设置心跳间隔&lt;/span&gt;
watchdog /dev/watchdog
deadtime 30              &lt;span class="c"&gt;#  在30秒后宣布节点死亡&lt;/span&gt;
warntime 10              &lt;span class="c"&gt;# 在日志中发出“late heartbeat“警告之前等待的时间，单位为秒&lt;/span&gt;
initdead 120             &lt;span class="c"&gt;# 网络启动时间&lt;/span&gt;
udpport        694       &lt;span class="c"&gt;# 广播/单播通讯使用的udp端口&lt;/span&gt;
&lt;span class="c"&gt;#baud   19200&lt;/span&gt;
&lt;span class="c"&gt;#serial  /dev/ttyS0      # 使用串口heartbeat&lt;/span&gt;
bcast   eth0             &lt;span class="c"&gt;# 使用网卡heartbeat,并在eth0接口上使用广播heartbeat&lt;/span&gt;
auto_failback on         &lt;span class="c"&gt;# 当主节点从故障中恢复时,将自动切换到主节点&lt;/span&gt;
watchdog /dev/watchdog   &lt;span class="c"&gt;# 该指令是用于设置看门狗定时器，如果节点一分钟内都没有心跳，那么节点将重新启动&lt;/span&gt;
node master.org          &lt;span class="c"&gt;# 集群中机器的主机名，与“uname –n”的输出相同。&lt;/span&gt;
node slave.org
ping 192.168.3.254       &lt;span class="c"&gt;# ping网关来检测链路正常&lt;/span&gt;
respawn hacluster /usr/local/lib/heartbeat/ipfail &lt;span class="c"&gt;# respawn调用/usr/lib/heartbeat/ipfail来主动进行切换&lt;/span&gt;
apiauth ipfail &lt;span class="nv"&gt;gid&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;haclient &lt;span class="nv"&gt;uid&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;hacluster   &lt;span class="c"&gt;# 设置启动ipfail的用户和组&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;配置haresources ,该文件列出所有节点所提供的服务以及服务的默认所有者.所有节点上的该文件必须相同&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;vi /etc/ha.d/haresources

master.org    IPaddr::192.168.3.103 mysql  &lt;span class="c"&gt;# vip&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;&lt;code&gt;注意:!!&lt;/code&gt;haresources最后一个字段是某个服务的心跳,如果mysql,如果主从库使用的是同一台盘阵或者一个分布式文件系统,这里一定要填写真实的启动脚本(/etc/init.d下),如果是主从同步的话请务必不填写真正的启动脚本,因为主库心跳存活的话heartbeat会自动停止从库的mysql,这样就无法同步,主库发生故障时转移故障就没有意义.&lt;/p&gt;
&lt;p&gt;配置authkeys, authkeys决定了您的认证密钥。共有三种认证方式：crc，md5，和sha1果您的Heartbeat运行于 安全 网络之上，如本例中的交叉线，可以使用crc，从资源的角度来看，这是代价最低的方法。如果网络并不 安全 ，但您也希望降低CPU使用，则使用md5。最后，如果您想得到最好的认证，而不考虑CPU使用情况，则使用sha1，它在三者之中最难破解。&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;vi /etc/ha.d/authkeys

auth 1
1 crc
chmod 600 /etc/ha.d/authkeys
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;不论您在关键字auth后面指定的是什么索引值，在后面必须要作为键值再次出现。如果您指定“auth 4”，则在后面一定要有一行的内容为“4 ”。
配置从库:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;scp root@192.168.3.101:/etc/ha.d/ha.cf /etc/ha.d/
scp root@192.168.3.101:/etc/ha.d/authkeys /etc/ha.d/
scp root@192.168.3.101:/etc/ha.d/haresources /etc/ha.d/
vi /etc/ha.d/ha.cf
debugfile /var/log/ha-debug
logfile /var/log/ha-log
logfacility     local0
keepalive 2
deadtime 30
warntime 10
initdead 120
udpport 694
bcast   eth0          
auto_failback on
node    master.org
node    slave.org
ping 192.168.3.254
respawn hacluser /usr/local/lib/heartbeat/ipfail &lt;span class="c"&gt;# respawn调用/usr/lib/heartbeat/ipfail来主动进行切换&lt;/span&gt;
apiauth ipfail &lt;span class="nv"&gt;gid&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;haclient &lt;span class="nv"&gt;uid&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;hacluster
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;启动主库heartbeat:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;server heartbeat start
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;查看日志:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;cat /var/log/ha-log

heartbeat&lt;span class="o"&gt;[&lt;/span&gt;32239&lt;span class="o"&gt;]&lt;/span&gt;: 2012/02/19_13:45:29 info: Link 192.168.3.254:192.168.3.254 up.
heartbeat&lt;span class="o"&gt;[&lt;/span&gt;32239&lt;span class="o"&gt;]&lt;/span&gt;: 2012/02/19_13:45:29 info: Status update &lt;span class="k"&gt;for &lt;/span&gt;node 192.168.3.254: status ping
heartbeat&lt;span class="o"&gt;[&lt;/span&gt;32239&lt;span class="o"&gt;]&lt;/span&gt;: 2012/02/19_13:45:29 info: Link master.org:eth0 up.
heartbeat&lt;span class="o"&gt;[&lt;/span&gt;32239&lt;span class="o"&gt;]&lt;/span&gt;: 2012/02/19_13:45:41 WARN: node slave.org: is dead
heartbeat&lt;span class="o"&gt;[&lt;/span&gt;32239&lt;span class="o"&gt;]&lt;/span&gt;: 2012/02/19_13:45:41 info: Comm_now_up&lt;span class="o"&gt;()&lt;/span&gt;: updating status to active
heartbeat&lt;span class="o"&gt;[&lt;/span&gt;32239&lt;span class="o"&gt;]&lt;/span&gt;: 2012/02/19_13:45:41 info: Local status now &lt;span class="nb"&gt;set &lt;/span&gt;to: &lt;span class="s1"&gt;&amp;#39;active&amp;#39;&lt;/span&gt;
heartbeat&lt;span class="o"&gt;[&lt;/span&gt;32239&lt;span class="o"&gt;]&lt;/span&gt;: 2012/02/19_13:45:41 info: Starting child client &lt;span class="s2"&gt;&amp;quot;/usr/local/lib/heartbeat/ipfail&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;503,503&lt;span class="o"&gt;)&lt;/span&gt;
heartbeat&lt;span class="o"&gt;[&lt;/span&gt;32239&lt;span class="o"&gt;]&lt;/span&gt;: 2012/02/19_13:45:41 WARN: No STONITH device configured.
heartbeat&lt;span class="o"&gt;[&lt;/span&gt;32239&lt;span class="o"&gt;]&lt;/span&gt;: 2012/02/19_13:45:41 WARN: Shared disks are not protected.
heartbeat&lt;span class="o"&gt;[&lt;/span&gt;32239&lt;span class="o"&gt;]&lt;/span&gt;: 2012/02/19_13:45:41 info: Resources being acquired from slave.org.
heartbeat&lt;span class="o"&gt;[&lt;/span&gt;32247&lt;span class="o"&gt;]&lt;/span&gt;: 2012/02/19_13:45:41 info: Starting &lt;span class="s2"&gt;&amp;quot;/usr/local/lib/heartbeat/ipfail&amp;quot;&lt;/span&gt; as uid 503  gid 503 &lt;span class="o"&gt;(&lt;/span&gt;pid 32247&lt;span class="o"&gt;)&lt;/span&gt;
harc&lt;span class="o"&gt;[&lt;/span&gt;32248&lt;span class="o"&gt;]&lt;/span&gt;:    2012/02/19_13:45:42 info: Running /etc/ha.d/rc.d/status status
mach_down&lt;span class="o"&gt;[&lt;/span&gt;32275&lt;span class="o"&gt;]&lt;/span&gt;:       2012/02/19_13:45:42 info: /usr/local/lib/heartbeat/mach_down: nice_failback: foreign resources acquired
mach_down&lt;span class="o"&gt;[&lt;/span&gt;32275&lt;span class="o"&gt;]&lt;/span&gt;:       2012/02/19_13:45:42 info: mach_down takeover &lt;span class="nb"&gt;complete &lt;/span&gt;&lt;span class="k"&gt;for &lt;/span&gt;node slave.org.
heartbeat&lt;span class="o"&gt;[&lt;/span&gt;32239&lt;span class="o"&gt;]&lt;/span&gt;: 2012/02/19_13:45:42 info: mach_down takeover complete.
heartbeat&lt;span class="o"&gt;[&lt;/span&gt;32239&lt;span class="o"&gt;]&lt;/span&gt;: 2012/02/19_13:45:42 info: Initial resource acquisition &lt;span class="nb"&gt;complete&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;mach_down&lt;span class="o"&gt;)&lt;/span&gt;
IPaddr&lt;span class="o"&gt;[&lt;/span&gt;32300&lt;span class="o"&gt;]&lt;/span&gt;:  2012/02/19_13:45:42 INFO:  Resource is stopped
heartbeat&lt;span class="o"&gt;[&lt;/span&gt;32249&lt;span class="o"&gt;]&lt;/span&gt;: 2012/02/19_13:45:42 info: Local Resource acquisition completed.
harc&lt;span class="o"&gt;[&lt;/span&gt;32338&lt;span class="o"&gt;]&lt;/span&gt;:    2012/02/19_13:45:42 info: Running /etc/ha.d/rc.d/ip-request-resp ip-request-resp
ip-request-resp&lt;span class="o"&gt;[&lt;/span&gt;32338&lt;span class="o"&gt;]&lt;/span&gt;: 2012/02/19_13:45:42 received ip-request-resp IPaddr::192.168.3.103 OK yes
ResourceManager&lt;span class="o"&gt;[&lt;/span&gt;32353&lt;span class="o"&gt;]&lt;/span&gt;: 2012/02/19_13:45:42 info: Acquiring resource group: master.org IPaddr::192.168.3.103 mysqld
IPaddr&lt;span class="o"&gt;[&lt;/span&gt;32377&lt;span class="o"&gt;]&lt;/span&gt;:  2012/02/19_13:45:42 INFO:  Resource is stopped
ResourceManager&lt;span class="o"&gt;[&lt;/span&gt;32353&lt;span class="o"&gt;]&lt;/span&gt;: 2012/02/19_13:45:42 info: Running /etc/ha.d/resource.d/IPaddr 192.168.3.103 start
IPaddr&lt;span class="o"&gt;[&lt;/span&gt;32429&lt;span class="o"&gt;]&lt;/span&gt;:  2012/02/19_13:45:42 INFO: Using calculated nic &lt;span class="k"&gt;for &lt;/span&gt;192.168.3.103: eth0
IPaddr&lt;span class="o"&gt;[&lt;/span&gt;32429&lt;span class="o"&gt;]&lt;/span&gt;:  2012/02/19_13:45:42 DEBUG: Using calculated netmask &lt;span class="k"&gt;for &lt;/span&gt;192.168.3.103: 255.255.255.0
IPaddr&lt;span class="o"&gt;[&lt;/span&gt;32429&lt;span class="o"&gt;]&lt;/span&gt;:  2012/02/19_13:45:42 DEBUG: Using calculated broadcast &lt;span class="k"&gt;for &lt;/span&gt;192.168.3.103: 192.168.3.255
IPaddr&lt;span class="o"&gt;[&lt;/span&gt;32429&lt;span class="o"&gt;]&lt;/span&gt;:  2012/02/19_13:45:42 INFO: &lt;span class="nb"&gt;eval&lt;/span&gt; /sbin/ifconfig eth0:0 192.168.3.103 netmask 255.255.255.0 broadcast 192.168.3.255
IPaddr&lt;span class="o"&gt;[&lt;/span&gt;32429&lt;span class="o"&gt;]&lt;/span&gt;:  2012/02/19_13:45:43 DEBUG: Sending Gratuitous Arp &lt;span class="k"&gt;for &lt;/span&gt;192.168.3.103 on eth0:0 &lt;span class="o"&gt;[&lt;/span&gt;eth0&lt;span class="o"&gt;]&lt;/span&gt;
IPaddr&lt;span class="o"&gt;[&lt;/span&gt;32420&lt;span class="o"&gt;]&lt;/span&gt;:  2012/02/19_13:45:43 INFO:  Success
ResourceManager&lt;span class="o"&gt;[&lt;/span&gt;32353&lt;span class="o"&gt;]&lt;/span&gt;: 2012/02/19_13:45:43 info: Running /etc/init.d/mysqld  start
heartbeat&lt;span class="o"&gt;[&lt;/span&gt;32239&lt;span class="o"&gt;]&lt;/span&gt;: 2012/02/19_13:45:56 info: Local Resource acquisition completed. &lt;span class="o"&gt;(&lt;/span&gt;none&lt;span class="o"&gt;)&lt;/span&gt;
heartbeat&lt;span class="o"&gt;[&lt;/span&gt;32239&lt;span class="o"&gt;]&lt;/span&gt;: 2012/02/19_13:45:56 info: &lt;span class="nb"&gt;local &lt;/span&gt;resource transition completed.
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;&amp;nbsp;&lt;/p&gt;
&lt;p&gt;从日志中看出来slave.org没起来是死亡的,并添加192.168.3.103vip&lt;/p&gt;
&lt;p&gt;启动从库heartbeat&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;server heartbeat start
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;启动之后查看日志信息&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;Feb 19 13:50:22 slave heartbeat: &lt;span class="o"&gt;[&lt;/span&gt;29159&lt;span class="o"&gt;]&lt;/span&gt;: info: Local status now &lt;span class="nb"&gt;set &lt;/span&gt;to: &lt;span class="s1"&gt;&amp;#39;up&amp;#39;&lt;/span&gt;
Feb 19 13:50:23 slave heartbeat: &lt;span class="o"&gt;[&lt;/span&gt;29159&lt;span class="o"&gt;]&lt;/span&gt;: info: Link master.org:eth0 up.
Feb 19 13:50:23 slave heartbeat: &lt;span class="o"&gt;[&lt;/span&gt;29159&lt;span class="o"&gt;]&lt;/span&gt;: info: Status update &lt;span class="k"&gt;for &lt;/span&gt;node master.org: status active
Feb 19 13:50:23 slave heartbeat: &lt;span class="o"&gt;[&lt;/span&gt;29159&lt;span class="o"&gt;]&lt;/span&gt;: info: Link 192.168.3.254:192.168.3.254 up.
Feb 19 13:50:23 slave heartbeat: &lt;span class="o"&gt;[&lt;/span&gt;29159&lt;span class="o"&gt;]&lt;/span&gt;: info: Status update &lt;span class="k"&gt;for &lt;/span&gt;node 192.168.3.254: status ping
Feb 19 13:50:23 slave heartbeat: &lt;span class="o"&gt;[&lt;/span&gt;29159&lt;span class="o"&gt;]&lt;/span&gt;: info: Link slave.org:eth0 up.
Feb 19 13:50:23 slave harc&lt;span class="o"&gt;[&lt;/span&gt;29171&lt;span class="o"&gt;]&lt;/span&gt;: info: Running /etc/ha.d/rc.d/status status
Feb 19 13:50:24 slave heartbeat: &lt;span class="o"&gt;[&lt;/span&gt;29159&lt;span class="o"&gt;]&lt;/span&gt;: info: Comm_now_up&lt;span class="o"&gt;()&lt;/span&gt;: updating status to active
Feb 19 13:50:24 slave heartbeat: &lt;span class="o"&gt;[&lt;/span&gt;29159&lt;span class="o"&gt;]&lt;/span&gt;: info: Local status now &lt;span class="nb"&gt;set &lt;/span&gt;to: &lt;span class="s1"&gt;&amp;#39;active&amp;#39;&lt;/span&gt;
Feb 19 13:50:24 slave heartbeat: &lt;span class="o"&gt;[&lt;/span&gt;29159&lt;span class="o"&gt;]&lt;/span&gt;: info: Starting child client &lt;span class="s2"&gt;&amp;quot;/usr/local/lib/heartbeat/ipfail&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;501,501&lt;span class="o"&gt;)&lt;/span&gt;
Feb 19 13:50:24 slave heartbeat: &lt;span class="o"&gt;[&lt;/span&gt;29159&lt;span class="o"&gt;]&lt;/span&gt;: WARN: G_CH_dispatch_int: Dispatch &lt;span class="k"&gt;function for &lt;/span&gt;&lt;span class="nb"&gt;read &lt;/span&gt;child took too long to execute: 140 ms &lt;span class="o"&gt;(&lt;/span&gt;&amp;amp;gt; 50 ms&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;GSource: 0x9b98448&lt;span class="o"&gt;)&lt;/span&gt;
Feb 19 13:50:24 slave heartbeat: &lt;span class="o"&gt;[&lt;/span&gt;29182&lt;span class="o"&gt;]&lt;/span&gt;: info: Starting &lt;span class="s2"&gt;&amp;quot;/usr/local/lib/heartbeat/ipfail&amp;quot;&lt;/span&gt; as uid 501  gid 501 &lt;span class="o"&gt;(&lt;/span&gt;pid 29182&lt;span class="o"&gt;)&lt;/span&gt;
Feb 19 13:50:24 slave heartbeat: &lt;span class="o"&gt;[&lt;/span&gt;29159&lt;span class="o"&gt;]&lt;/span&gt;: info: remote resource transition completed.
Feb 19 13:50:24 slave heartbeat: &lt;span class="o"&gt;[&lt;/span&gt;29159&lt;span class="o"&gt;]&lt;/span&gt;: info: remote resource transition completed.
Feb 19 13:50:24 slave heartbeat: &lt;span class="o"&gt;[&lt;/span&gt;29159&lt;span class="o"&gt;]&lt;/span&gt;: info: Local Resource acquisition completed. &lt;span class="o"&gt;(&lt;/span&gt;none&lt;span class="o"&gt;)&lt;/span&gt;
Feb 19 13:50:25 slave heartbeat: &lt;span class="o"&gt;[&lt;/span&gt;29159&lt;span class="o"&gt;]&lt;/span&gt;: info: master.org wants to go standby &lt;span class="o"&gt;[&lt;/span&gt;foreign&lt;span class="o"&gt;]&lt;/span&gt;
Feb 19 13:50:26 slave heartbeat: &lt;span class="o"&gt;[&lt;/span&gt;29159&lt;span class="o"&gt;]&lt;/span&gt;: info: standby: acquire &lt;span class="o"&gt;[&lt;/span&gt;foreign&lt;span class="o"&gt;]&lt;/span&gt; resources from master.org
Feb 19 13:50:26 slave heartbeat: &lt;span class="o"&gt;[&lt;/span&gt;29183&lt;span class="o"&gt;]&lt;/span&gt;: info: acquire &lt;span class="nb"&gt;local &lt;/span&gt;HA resources &lt;span class="o"&gt;(&lt;/span&gt;standby&lt;span class="o"&gt;)&lt;/span&gt;.
Feb 19 13:50:26 slave heartbeat: &lt;span class="o"&gt;[&lt;/span&gt;29183&lt;span class="o"&gt;]&lt;/span&gt;: info: &lt;span class="nb"&gt;local &lt;/span&gt;HA resource acquisition completed &lt;span class="o"&gt;(&lt;/span&gt;standby&lt;span class="o"&gt;)&lt;/span&gt;.
Feb 19 13:50:26 slave heartbeat: &lt;span class="o"&gt;[&lt;/span&gt;29159&lt;span class="o"&gt;]&lt;/span&gt;: info: Standby resource acquisition &lt;span class="k"&gt;done&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;foreign&lt;span class="o"&gt;]&lt;/span&gt;.
Feb 19 13:50:26 slave heartbeat: &lt;span class="o"&gt;[&lt;/span&gt;29159&lt;span class="o"&gt;]&lt;/span&gt;: info: Initial resource acquisition &lt;span class="nb"&gt;complete&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;auto_failback&lt;span class="o"&gt;)&lt;/span&gt;
Feb 19 13:50:27 slave heartbeat: &lt;span class="o"&gt;[&lt;/span&gt;29159&lt;span class="o"&gt;]&lt;/span&gt;: info: remote resource transition completed.
Feb 19 13:50:36 slave ipfail: &lt;span class="o"&gt;[&lt;/span&gt;29182&lt;span class="o"&gt;]&lt;/span&gt;: info: Ping node count is balanced.
Feb 19 13:50:37 slave ipfail: &lt;span class="o"&gt;[&lt;/span&gt;29182&lt;span class="o"&gt;]&lt;/span&gt;: info: Giving up foreign resources &lt;span class="o"&gt;(&lt;/span&gt;auto_failback&lt;span class="o"&gt;)&lt;/span&gt;.
Feb 19 13:50:37 slave ipfail: &lt;span class="o"&gt;[&lt;/span&gt;29182&lt;span class="o"&gt;]&lt;/span&gt;: info: Delayed giveup in 4 seconds.
Feb 19 13:50:42 slave ipfail: &lt;span class="o"&gt;[&lt;/span&gt;29182&lt;span class="o"&gt;]&lt;/span&gt;: info: giveup&lt;span class="o"&gt;()&lt;/span&gt; called &lt;span class="o"&gt;(&lt;/span&gt;timeout worked&lt;span class="o"&gt;)&lt;/span&gt;
Feb 19 13:50:42 slave heartbeat: &lt;span class="o"&gt;[&lt;/span&gt;29159&lt;span class="o"&gt;]&lt;/span&gt;: info: slave.org wants to go standby &lt;span class="o"&gt;[&lt;/span&gt;foreign&lt;span class="o"&gt;]&lt;/span&gt;
Feb 19 13:50:43 slave heartbeat: &lt;span class="o"&gt;[&lt;/span&gt;29159&lt;span class="o"&gt;]&lt;/span&gt;: info: standby: master.org can take our foreign resources
Feb 19 13:50:43 slave heartbeat: &lt;span class="o"&gt;[&lt;/span&gt;29194&lt;span class="o"&gt;]&lt;/span&gt;: info: give up foreign HA resources &lt;span class="o"&gt;(&lt;/span&gt;standby&lt;span class="o"&gt;)&lt;/span&gt;.
Feb 19 13:50:43 slave ResourceManager&lt;span class="o"&gt;[&lt;/span&gt;29204&lt;span class="o"&gt;]&lt;/span&gt;: info: Releasing resource group: master.org IPaddr::192.168.3.103 mysqld
Feb 19 13:50:43 slave ResourceManager&lt;span class="o"&gt;[&lt;/span&gt;29204&lt;span class="o"&gt;]&lt;/span&gt;: info: Running /etc/init.d/mysqld  stop
Feb 19 13:50:45 slave ResourceManager&lt;span class="o"&gt;[&lt;/span&gt;29204&lt;span class="o"&gt;]&lt;/span&gt;: info: Running /etc/ha.d/resource.d/IPaddr 192.168.3.103 stop
Feb 19 13:50:45 slave IPaddr&lt;span class="o"&gt;[&lt;/span&gt;29279&lt;span class="o"&gt;]&lt;/span&gt;: INFO:  Success
Feb 19 13:50:45 slave heartbeat: &lt;span class="o"&gt;[&lt;/span&gt;29194&lt;span class="o"&gt;]&lt;/span&gt;: info: foreign HA resource release completed &lt;span class="o"&gt;(&lt;/span&gt;standby&lt;span class="o"&gt;)&lt;/span&gt;.
Feb 19 13:50:45 slave heartbeat: &lt;span class="o"&gt;[&lt;/span&gt;29159&lt;span class="o"&gt;]&lt;/span&gt;: info: Local standby process completed &lt;span class="o"&gt;[&lt;/span&gt;foreign&lt;span class="o"&gt;]&lt;/span&gt;.
Feb 19 13:50:46 slave heartbeat: &lt;span class="o"&gt;[&lt;/span&gt;29159&lt;span class="o"&gt;]&lt;/span&gt;: WARN: 1 lost packet&lt;span class="o"&gt;(&lt;/span&gt;s&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;master.org&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;162:164&lt;span class="o"&gt;]&lt;/span&gt;
Feb 19 13:50:46 slave heartbeat: &lt;span class="o"&gt;[&lt;/span&gt;29159&lt;span class="o"&gt;]&lt;/span&gt;: info: remote resource transition completed.
Feb 19 13:50:46 slave heartbeat: &lt;span class="o"&gt;[&lt;/span&gt;29159&lt;span class="o"&gt;]&lt;/span&gt;: info: No pkts missing from master.org!
Feb 19 13:50:46 slave heartbeat: &lt;span class="o"&gt;[&lt;/span&gt;29159&lt;span class="o"&gt;]&lt;/span&gt;: info: Other node completed standby takeover of foreign resources.
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;现在尝试停止主库的MySQL服务&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;pkill mysqld
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;查看日志并无变化,所以得出结论heartbeat只检测心跳也就是只检测设备是否宕机,不会检测MySQL服务,所以我们同样要有一个脚本来检测MySQL服务,如果mysql服务宕掉,则尝试启动服务,若启动服务失败则kill掉heartbeat进程实现故障转移(和上一遍nginx+keepalived原理一致),脚本内容如下:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;&lt;span class="c"&gt;#!/bin/bash&lt;/span&gt;
&lt;span class="c"&gt;# filename:mysqlsc.sh&lt;/span&gt;
ps aux ¦ grep mysqld ¦ grep -v grep 2&amp;amp;gt; /dev/null 1&amp;amp;gt;&amp;amp;amp;2   &lt;span class="c"&gt;# 过滤mysql进程&lt;/span&gt;
&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="o"&gt;[[&lt;/span&gt; &lt;span class="nv"&gt;$?&lt;/span&gt; -eq 0 &lt;span class="o"&gt;]]&lt;/span&gt;               &lt;span class="c"&gt;# 如果过滤有mysql进程会返回0则认为mysql存活&lt;/span&gt;
&lt;span class="k"&gt;then&lt;/span&gt;
&lt;span class="k"&gt;    &lt;/span&gt;sleep 5                     &lt;span class="c"&gt;# 使脚本进入休眠&lt;/span&gt;
&lt;span class="k"&gt;else&lt;/span&gt;
&lt;span class="c"&gt;# 如果nginx没有存活尝试启动mysql,如果失败则杀死heartbeat的进程&lt;/span&gt;
    /etc/init.d/mysqld start
    ps aux ¦ grep mysqld ¦ grep -v grep 2&amp;amp;gt; /dev/null 1&amp;amp;gt;&amp;amp;amp;2
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="o"&gt;[[&lt;/span&gt; &lt;span class="nv"&gt;$?&lt;/span&gt; -eq 0 &lt;span class="o"&gt;]]&lt;/span&gt;
    &lt;span class="k"&gt;then&lt;/span&gt;
&lt;span class="k"&gt;        &lt;/span&gt;pkill heartbeat
    &lt;span class="k"&gt;fi&lt;/span&gt;
&lt;span class="k"&gt;fi&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;给这个脚本执行权限然后后台运行:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;chmod +x mysqlsc.sh
nohup sh mysqlsc.sh &amp;amp;amp; &lt;span class="c"&gt;# 后台运行&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;下面来尝试停止主库的heartbeat:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;service heartbeat stop
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;查看从库日志:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;heartbeat&lt;span class="o"&gt;[&lt;/span&gt;29159&lt;span class="o"&gt;]&lt;/span&gt;: 2012/02/19_14:03:05 info: Received shutdown notice from &lt;span class="s1"&gt;&amp;#39;master.org&amp;#39;&lt;/span&gt;.
heartbeat&lt;span class="o"&gt;[&lt;/span&gt;29159&lt;span class="o"&gt;]&lt;/span&gt;: 2012/02/19_14:03:05 info: Resources being acquired from master.org.
heartbeat&lt;span class="o"&gt;[&lt;/span&gt;29308&lt;span class="o"&gt;]&lt;/span&gt;: 2012/02/19_14:03:05 info: acquire &lt;span class="nb"&gt;local &lt;/span&gt;HA resources &lt;span class="o"&gt;(&lt;/span&gt;standby&lt;span class="o"&gt;)&lt;/span&gt;.
heartbeat&lt;span class="o"&gt;[&lt;/span&gt;29308&lt;span class="o"&gt;]&lt;/span&gt;: 2012/02/19_14:03:05 info: &lt;span class="nb"&gt;local &lt;/span&gt;HA resource acquisition completed &lt;span class="o"&gt;(&lt;/span&gt;standby&lt;span class="o"&gt;)&lt;/span&gt;.
heartbeat&lt;span class="o"&gt;[&lt;/span&gt;29159&lt;span class="o"&gt;]&lt;/span&gt;: 2012/02/19_14:03:05 info: Standby resource acquisition &lt;span class="k"&gt;done&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;foreign&lt;span class="o"&gt;]&lt;/span&gt;.
heartbeat&lt;span class="o"&gt;[&lt;/span&gt;29309&lt;span class="o"&gt;]&lt;/span&gt;: 2012/02/19_14:03:05 info: No &lt;span class="nb"&gt;local &lt;/span&gt;resources &lt;span class="o"&gt;[&lt;/span&gt;/usr/local/lib/heartbeat/ResourceManager listkeys slave.org&lt;span class="o"&gt;]&lt;/span&gt; to acquire.
harc&lt;span class="o"&gt;[&lt;/span&gt;29328&lt;span class="o"&gt;]&lt;/span&gt;:    2012/02/19_14:03:05 info: Running /etc/ha.d/rc.d/status status
mach_down&lt;span class="o"&gt;[&lt;/span&gt;29338&lt;span class="o"&gt;]&lt;/span&gt;:       2012/02/19_14:03:05 info: Taking over resource group IPaddr::192.168.3.103
ResourceManager&lt;span class="o"&gt;[&lt;/span&gt;29358&lt;span class="o"&gt;]&lt;/span&gt;: 2012/02/19_14:03:05 info: Acquiring resource group: master.org IPaddr::192.168.3.103 mysqld
IPaddr&lt;span class="o"&gt;[&lt;/span&gt;29382&lt;span class="o"&gt;]&lt;/span&gt;:  2012/02/19_14:03:05 INFO:  Resource is stopped
ResourceManager&lt;span class="o"&gt;[&lt;/span&gt;29358&lt;span class="o"&gt;]&lt;/span&gt;: 2012/02/19_14:03:06 info: Running /etc/ha.d/resource.d/IPaddr 192.168.3.103 start
IPaddr&lt;span class="o"&gt;[&lt;/span&gt;29434&lt;span class="o"&gt;]&lt;/span&gt;:  2012/02/19_14:03:06 INFO: Using calculated nic &lt;span class="k"&gt;for &lt;/span&gt;192.168.3.103: eth0
IPaddr&lt;span class="o"&gt;[&lt;/span&gt;29434&lt;span class="o"&gt;]&lt;/span&gt;:  2012/02/19_14:03:06 DEBUG: Using calculated netmask &lt;span class="k"&gt;for &lt;/span&gt;192.168.3.103: 255.255.255.0
IPaddr&lt;span class="o"&gt;[&lt;/span&gt;29434&lt;span class="o"&gt;]&lt;/span&gt;:  2012/02/19_14:03:06 DEBUG: Using calculated broadcast &lt;span class="k"&gt;for &lt;/span&gt;192.168.3.103: 192.168.3.255
IPaddr&lt;span class="o"&gt;[&lt;/span&gt;29434&lt;span class="o"&gt;]&lt;/span&gt;:  2012/02/19_14:03:06 INFO: &lt;span class="nb"&gt;eval&lt;/span&gt; /sbin/ifconfig eth0:0 192.168.3.103 netmask 255.255.255.0 broadcast 192.168.3.255
IPaddr&lt;span class="o"&gt;[&lt;/span&gt;29434&lt;span class="o"&gt;]&lt;/span&gt;:  2012/02/19_14:03:06 DEBUG: Sending Gratuitous Arp &lt;span class="k"&gt;for &lt;/span&gt;192.168.3.103 on eth0:0 &lt;span class="o"&gt;[&lt;/span&gt;eth0&lt;span class="o"&gt;]&lt;/span&gt;
IPaddr&lt;span class="o"&gt;[&lt;/span&gt;29425&lt;span class="o"&gt;]&lt;/span&gt;:  2012/02/19_14:03:06 INFO:  Success
ResourceManager&lt;span class="o"&gt;[&lt;/span&gt;29358&lt;span class="o"&gt;]&lt;/span&gt;: 2012/02/19_14:03:06 info: Running /etc/init.d/mysqld  start
mach_down&lt;span class="o"&gt;[&lt;/span&gt;29338&lt;span class="o"&gt;]&lt;/span&gt;:       2012/02/19_14:03:07 info: /usr/local/lib/heartbeat/mach_down: nice_failback: foreign resources acquired
mach_down&lt;span class="o"&gt;[&lt;/span&gt;29338&lt;span class="o"&gt;]&lt;/span&gt;:       2012/02/19_14:03:07 info: mach_down takeover &lt;span class="nb"&gt;complete &lt;/span&gt;&lt;span class="k"&gt;for &lt;/span&gt;node master.org.
heartbeat&lt;span class="o"&gt;[&lt;/span&gt;29159&lt;span class="o"&gt;]&lt;/span&gt;: 2012/02/19_14:03:07 info: mach_down takeover complete.
heartbeat&lt;span class="o"&gt;[&lt;/span&gt;29159&lt;span class="o"&gt;]&lt;/span&gt;: 2012/02/19_14:03:17 WARN: node master.org: is dead
heartbeat&lt;span class="o"&gt;[&lt;/span&gt;29159&lt;span class="o"&gt;]&lt;/span&gt;: 2012/02/19_14:03:17 info: Dead node master.org gave up resources.
heartbeat&lt;span class="o"&gt;[&lt;/span&gt;29159&lt;span class="o"&gt;]&lt;/span&gt;: 2012/02/19_14:03:17 info: Link master.org:eth0 dead.
&lt;/pre&gt;&lt;/div&gt;</summary><category term="高可用"></category><category term="心跳"></category><category term="双机"></category><category term="vip"></category><category term="MySQL"></category><category term="heartbeat"></category></entry><entry><title>MySQL优化笔记</title><link href="http://localhost:8000/mysqlyou-hua-bi-ji.html" rel="alternate"></link><updated>2012-02-04T13:36:00+08:00</updated><author><name>cold</name></author><id>tag:localhost:8000,2012-02-04:mysqlyou-hua-bi-ji.html</id><summary type="html">&lt;p&gt;之前安装时没注意MySQL的优化,先想对MySQL做一下优化.首先看一下没有优化之前各个参数:
MySQL预编译参数:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt; ./configure  --prefix&lt;span class="o"&gt;=&lt;/span&gt;/usr/local/mysql --with-ssl --with-readline --with-big-tables --enable-assembler
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;top&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;32553 mysql     20   0  125m  17m 4064 S  0.0  1.7   5:13.01 mysqld
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;使用mysqlreport获取MySQL运行参数:&lt;!--more--&gt;&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;MySQL 5.0.40-log         uptime 15 22:1:21      Sat Feb  4 10:04:23 2012

__ Key _________________________________________________________________
Buffer used    62.00k of  16.00M  %Used:   0.38
  Current       1.90M            %Usage:  11.89
Write hit      22.29%
Read hit       99.83%

__ Questions ___________________________________________________________
Total          85.58k     0.1/s
  DMS          77.61k     0.1/s  %Total:  90.69
  Com_          5.37k     0.0/s            6.28
  COM_QUIT      2.52k     0.0/s            2.95
  +Unknown         78     0.0/s            0.09
Slow 10 s           0       0/s            0.00  %DMS:   0.00  Log: OFF
DMS            77.61k     0.1/s           90.69
  SELECT       72.77k     0.1/s           85.03         93.76
  UPDATE        2.68k     0.0/s            3.13          3.45
  INSERT        1.09k     0.0/s            1.27          1.41
  DELETE        1.07k     0.0/s            1.25          1.38
  REPLACE           0       0/s            0.00          0.00
Com_            5.37k     0.0/s            6.28
  set_option    2.60k     0.0/s            3.04
  change_db     2.52k     0.0/s            2.94
  show_fields      77     0.0/s            0.09

__ SELECT and Sort _____________________________________________________
Scan            5.17k     0.0/s %SELECT:   7.10
Range           2.75k     0.0/s            3.77
Full join           0       0/s            0.00
Range check         0       0/s            0.00
Full rng join       0       0/s            0.00
Sort scan       5.97k     0.0/s
Sort range      4.30k     0.0/s
Sort mrg pass       0       0/s

__ Table Locks _________________________________________________________
Waited             24     0.0/s  %Total:   0.03
Immediate      91.00k     0.1/s

__ Tables ______________________________________________________________
Open               36 of   64    %Cache:  56.25
Opened             42     0.0/s

__ Connections _________________________________________________________
Max used            5 of  100      %Max:   5.00
Total           2.52k     0.0/s

__ Created Temp ________________________________________________________
Disk table      4.15k     0.0/s
Table           7.11k     0.0/s    Size:  32.0M
File                5     0.0/s

__ Threads _____________________________________________________________
Running             1 of    1
Cached              0 of    0      %Hit:   0.04
Created         2.52k     0.0/s
Slow                0       0/s

__ Aborted _____________________________________________________________
Clients             0       0/s
Connects            0       0/s

__ Bytes _______________________________________________________________
Sent          226.71M   164.8/s
Received       12.59M     9.2/s

__ InnoDB Buffer Pool __________________________________________________
Usage         304.00k of   8.00M  %Used:   3.71
Read hit       84.42%
Pages
  Free            493            %Total:  96.29
  Data             19                      3.71 %Drty:   0.00
  Misc              0                      0.00
  Latched           0                      0.00
Reads              77     0.0/s
  From file        12     0.0/s           15.58
  Ahead Rnd         1     0.0/s
  Ahead Sql         0       0/s
Writes              0       0/s
Flushes             0       0/s
Wait Free           0       0/s

__ InnoDB Lock _________________________________________________________
Waits               0       0/s
Current             0
Time acquiring
  Total             0 ms
  Average           0 ms
  Max               0 ms

__ InnoDB Data, Pages, Rows ____________________________________________
Data
  Reads            25     0.0/s
  Writes            3     0.0/s
  fsync             3     0.0/s
  Pending
    Reads           0
    Writes          0
    fsync           0

Pages
  Created           0       0/s
  Read             19     0.0/s
  Written           0       0/s

Rows
  Deleted           0       0/s
  Inserted          0       0/s
  Read              0       0/s
  Updated           0       0/s
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;首先在预编译参数上进行优化&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;./configure --prefix&lt;span class="o"&gt;=&lt;/span&gt;/usr/local/mysql &lt;span class="se"&gt;\&lt;/span&gt;
--without-debug &lt;span class="se"&gt;\ &lt;/span&gt;                                &lt;span class="c"&gt;# 取消调试模式提高性能&lt;/span&gt;
--with-extra-charsets&lt;span class="o"&gt;=&lt;/span&gt;utf8,gbk &lt;span class="se"&gt;\ &lt;/span&gt;                 &lt;span class="c"&gt;# 仅仅指定需要的默认字符集提高性能&lt;/span&gt;
--enable-assembler &lt;span class="se"&gt;\ &lt;/span&gt;                             &lt;span class="c"&gt;# 使用汇编模式提高性能&lt;/span&gt;
--with-mysqld-ldflags&lt;span class="o"&gt;=&lt;/span&gt;-all-static &lt;span class="se"&gt;\ &lt;/span&gt;              &lt;span class="c"&gt;# 以静态方式编译提高性能&lt;/span&gt;
--with-client-ldflags&lt;span class="o"&gt;=&lt;/span&gt;-all-static &lt;span class="se"&gt;\&lt;/span&gt;
--with-unix-socket-path&lt;span class="o"&gt;=&lt;/span&gt;/tmp/mysql.sock &lt;span class="se"&gt;\ &lt;/span&gt;        &lt;span class="c"&gt;# 使用unix socket提高性能&lt;/span&gt;
--with-ssl
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;安装完成后进一步优化my.cnf:
因为MySQL 只会 Cache 索引(*.MYI)，因此您只要将数据库中所有的 MYI 档案加总起来就是key buffer 的值,计算MYI档案的总大小:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;du -hc &lt;span class="sb"&gt;`&lt;/span&gt;find /usr/local/mysql/var/ -name *.MYI&lt;span class="sb"&gt;`&lt;/span&gt;
4.0K    /usr/local/mysql/var/myblog/wp_term_taxonomy.MYI
8.0K    /usr/local/mysql/var/myblog/wp_posts.MYI
8.0K    /usr/local/mysql/var/myblog/wp_usermeta.MYI
8.0K    /usr/local/mysql/var/myblog/wp_commentmeta.MYI
16K     /usr/local/mysql/var/myblog/wp_options.MYI
12K     /usr/local/mysql/var/myblog/wp_postmeta.MYI
8.0K    /usr/local/mysql/var/myblog/wp_comments.MYI
4.0K    /usr/local/mysql/var/myblog/wp_links.MYI
4.0K    /usr/local/mysql/var/myblog/wp_term_relationships.MYI
4.0K    /usr/local/mysql/var/myblog/wp_users.MYI
8.0K    /usr/local/mysql/var/myblog/wp_terms.MYI
16K     /usr/local/mysql/var/mysql/help_relation.MYI
4.0K    /usr/local/mysql/var/mysql/time_zone_name.MYI
16K     /usr/local/mysql/var/mysql/help_keyword.MYI
4.0K    /usr/local/mysql/var/mysql/func.MYI
4.0K    /usr/local/mysql/var/mysql/time_zone.MYI
20K     /usr/local/mysql/var/mysql/help_topic.MYI
4.0K    /usr/local/mysql/var/mysql/columns_priv.MYI
4.0K    /usr/local/mysql/var/mysql/procs_priv.MYI
4.0K    /usr/local/mysql/var/mysql/time_zone_leap_second.MYI
4.0K    /usr/local/mysql/var/mysql/user.MYI
4.0K    /usr/local/mysql/var/mysql/tables_priv.MYI
4.0K    /usr/local/mysql/var/mysql/host.MYI
4.0K    /usr/local/mysql/var/mysql/time_zone_transition_type.MYI
4.0K    /usr/local/mysql/var/mysql/proc.MYI
4.0K    /usr/local/mysql/var/mysql/help_category.MYI
4.0K    /usr/local/mysql/var/mysql/db.MYI
4.0K    /usr/local/mysql/var/mysql/time_zone_transition.MYI
192K    total
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;修改my.cnf参数大小:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;vi /etc/my.cnf
&lt;span class="c"&gt;# 降低key_buffer的值&lt;/span&gt;
&lt;span class="nv"&gt;key_buffer&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; 4M
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;重启MySQL执行top命令:&lt;/p&gt;
&lt;div class="codehilite"&gt;&lt;pre&gt;18125 mysql     20   0  109m  11m 2152 S  0.0  1.1   0:00.08 mysqld
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;看到MySQL的内存利用率降低到1.1,这时候还不适宜执行mysqlreport查看等待启动一天后查看.由于现在访问量较低,所以参数适量调低,需要实时监控MySQL运行状况适当运行参数.&lt;/p&gt;</summary><category term="编译参数"></category><category term="优化"></category><category term="mysql配置文件"></category><category term="MySQL服务"></category><category term="MySQL"></category><category term="my.cnf"></category></entry></feed>